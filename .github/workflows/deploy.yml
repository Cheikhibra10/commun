name: ðŸ“¦ Deploy commun

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    outputs:
      commun_version: ${{ steps.version.outputs.version }}

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Setup Java 21
      - name: Setup Java 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      # 3. Generate unique version with timestamp
      - name: Generate version with timestamp
        id: version
        run: |
          VERSION="0.0.5-$(date +%Y%m%d%H%M%S)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      # 4. Configure Maven settings (GitHub Packages)
      - name: Configure Maven settings
        run: |
          mkdir -p ~/.m2
          cat <<EOF > ~/.m2/settings.xml
          <settings>
            <servers>
              <server>
                <id>github</id>
                <username>${{ github.actor }}</username>
                <password>${{ secrets.GITHUB_TOKEN }}</password>
              </server>
            </servers>
          </settings>
          EOF

      # 5. Make Maven Wrapper executable
      - name: Make mvnw executable
        run: chmod +x ./mvnw

      # 6. Clean project to avoid old artifacts
      - name: Clean project
        run: ./mvnw clean

      # 7. Update version in pom.xml
      - name: Set commun version
        run: ./mvnw versions:set -DnewVersion=${{ steps.version.outputs.version }} -DgenerateBackupPoms=false

      # 8. Build & Deploy commun to GitHub Packages
      - name: Build and Deploy commun
        run: ./mvnw deploy -DskipTests -DretryFailedDeploymentCount=3

      # 9. Trigger pedagogie-service workflow
      - name: Trigger pedagogie-service build
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.PAT_TOKEN }}
          repository: Cheikhibra10/E221_Projet
          event-type: commun-published
          client-payload: '{"version": "${{ steps.version.outputs.version }}"}'
